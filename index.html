<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER TEMP | noyanov.com</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-cyan: #0ff;
            --neon-pink: #f0f;
            --matrix-green: #0f0;
            --dark-bg: #0a0a12;
            --alarm-red: #f00;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: var(--dark-bg);
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            overflow: hidden;
            position: relative;
            transition: background-color 0.5s;
        }
        
        /* Alarm animation */
        @keyframes alarm-blink {
            0% { background-color: #0a0a12; }
            50% { background-color: #300; }
            100% { background-color: #0a0a12; }
        }
        
        body.alarm-active {
            animation: alarm-blink 0.8s infinite;
        }
        
        /* Cyber Grid Background */
        .grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -1;
        }
        
        .terminal {
            max-width: 800px;
            margin: 5vh auto;
            border: 1px solid var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            border-radius: 8px;
            overflow: hidden;
            background: rgba(10, 15, 30, 0.85);
            backdrop-filter: blur(5px);
            transition: all 0.5s;
        }
        
        body.alarm-active .terminal {
            border-color: var(--alarm-red);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.7);
        }
        
        .header {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 20px;
            border-bottom: 1px solid var(--neon-pink);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-cyan);
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
            letter-spacing: 2px;
            font-size: 1.8rem;
        }
        
        .status {
            color: var(--matrix-green);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--matrix-green);
            margin-right: 8px;
            box-shadow: 0 0 8px var(--matrix-green);
            animation: pulse 1.5s infinite;
        }
        
        .content {
            padding: 30px;
            text-align: center;
        }
        
        .temperature-display {
            font-size: 8rem;
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-pink);
            text-shadow: 0 0 15px rgba(240, 0, 240, 0.7);
            margin: 30px 0;
            position: relative;
            transition: text-shadow 0.5s;
        }
        
        .unit {
            font-size: 2rem;
            color: var(--neon-cyan);
            vertical-align: super;
        }
        
        .location {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            letter-spacing: 1px;
            margin-bottom: 40px;
        }
        
        .location span {
            color: var(--neon-cyan);
        }
        
        .graph-container {
            height: 200px;
            margin: 40px 0;
            position: relative;
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .btn {
            background: transparent;
            color: var(--neon-cyan);
            border: 1px solid var(--neon-cyan);
            padding: 12px 25px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 500;
            font-size: 1.1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            letter-spacing: 1px;
        }
        
        .btn:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }
        
        .btn.alert {
            color: var(--neon-pink);
            border-color: var(--neon-pink);
        }
        
        .btn.alert:hover {
            background: rgba(240, 0, 240, 0.1);
            box-shadow: 0 0 15px rgba(240, 0, 240, 0.5);
        }
        
        .last-update {
            color: rgba(255, 255, 255, 0.5);
            margin-top: 25px;
            font-size: 0.9rem;
        }
        
        .alarm-indicator {
            margin-top: 15px;
            color: rgba(255, 50, 50, 0.8);
            font-size: 1.1rem;
            display: none;
        }
        
        body.alarm-active .alarm-indicator {
            display: block;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        /* Offline status */
        .status-offline .status-indicator {
            background: #f00;
            box-shadow: 0 0 8px #f00;
        }
        .status-offline .status span {
            color: #f00;
        }
    </style>
</head>
<body>
    <div class="grid"></div>
    
    <div class="terminal">
        <div class="header">
            <div class="title">CYBER TEMP v2.0</div>
            <div class="status" id="deviceStatus">
                <div class="status-indicator"></div>
                <span>CONNECTING...</span>
            </div>
        </div>
        
        <div class="content">
            <div class="location">DEVICE: <span id="deviceId">ESP32-C3-SUPERMINI</span> | NETWORK: <span id="networkStatus">--</span></div>
            
            <div class="temperature-display">
                <span id="tempValue">--</span><span class="unit">°C</span>
            </div>
            
            <div class="alarm-indicator" id="alarmIndicator">ALARM! TEMPERATURE EXCEEDED!</div>
            
            <div class="graph-container">
                <canvas id="tempChart"></canvas>
            </div>
            
            <div class="controls">
                <button class="btn" id="refreshBtn">REFRESH DATA</button>
                <button class="btn alert" id="alertBtn">SET ALARM</button>
            </div>
            
            <div class="last-update" id="lastUpdate">LAST UPDATE: --:--:--</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // DOM Elements
        const tempValue = document.getElementById('tempValue');
        const lastUpdate = document.getElementById('lastUpdate');
        const refreshBtn = document.getElementById('refreshBtn');
        const alertBtn = document.getElementById('alertBtn');
        const alarmIndicator = document.getElementById('alarmIndicator');
        const deviceStatus = document.getElementById('deviceStatus');
        const deviceId = document.getElementById('deviceId');
        const networkStatus = document.getElementById('networkStatus');
        
        // API Endpoints
        const TEMPERATURE_API = 'https://noyanov.com/Apps/Temp/api/temperature.php';
        
        // Global variables
        let alarmThreshold = null;
        let alarmActive = false;
        let currentTemp = null;
        let tempHistory = [];
        let lastUpdateTime = null;
        
        // Chart initialization
        const ctx = document.getElementById('tempChart').getContext('2d');
        const tempChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(20).fill(''),
                datasets: [{
                    label: 'Temperature History',
                    data: [],
                    borderColor: '#f0f',
                    backgroundColor: 'rgba(240, 0, 240, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 10,
                        max: 40,
                        grid: { color: 'rgba(0, 255, 255, 0.1)' },
                        ticks: { color: '#0ff' }
                    },
                    x: { display: false }
                },
                plugins: { legend: { display: false } }
            }
        });
        
        // Update device status
        function updateDeviceStatus(online) {
            const statusElement = deviceStatus.querySelector('span');
            const indicator = deviceStatus.querySelector('.status-indicator');
            
            if (online) {
                deviceStatus.classList.remove('status-offline');
                statusElement.textContent = 'ESP32-C3 ONLINE';
                indicator.style.background = '#0f0';
                indicator.style.boxShadow = '0 0 8px #0f0';
                networkStatus.textContent = '5Ghz';
            } else {
                deviceStatus.classList.add('status-offline');
                statusElement.textContent = 'ESP32-C3 OFFLINE';
                indicator.style.background = '#f00';
                indicator.style.boxShadow = '0 0 8px #f00';
                networkStatus.textContent = 'DISCONNECTED';
            }
        }
        
        // Update temperature display
        function updateTemperature(temp, timestamp) {
            currentTemp = parseFloat(temp);
            tempValue.textContent = temp;
            
            // Add to chart data
            if(tempChart.data.datasets[0].data.length >= 20) {
                tempChart.data.datasets[0].data.shift();
            }
            tempChart.data.datasets[0].data.push(currentTemp);
            tempChart.update();
            
            // Update timestamp
            lastUpdateTime = new Date(timestamp);
            lastUpdate.textContent = `LAST UPDATE: ${lastUpdateTime.toLocaleTimeString()}`;
            
            // Visual feedback for high temperature
            tempValue.style.textShadow = currentTemp > 30 
                ? '0 0 25px rgba(240, 0, 240, 1)' 
                : '0 0 15px rgba(240, 0, 240, 0.7)';
            
            // Alarm logic
            if (alarmThreshold !== null && currentTemp > alarmThreshold) {
                if (!alarmActive) {
                    document.body.classList.add('alarm-active');
                    alarmActive = true;
                    alarmIndicator.textContent = `ALARM! TEMP EXCEEDED ${alarmThreshold}°C!`;
                }
            } else if (alarmActive) {
                document.body.classList.remove('alarm-active');
                alarmActive = false;
            }
        }
        
        // Fetch temperature from server
        async function fetchTemperature() {
            try {
                const response = await fetch(TEMPERATURE_API, {
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.temperature) {
                    updateDeviceStatus(true);
                    updateTemperature(data.temperature, data.timestamp);
                } else {
                    throw new Error('Invalid temperature data');
                }
            } catch (error) {
                console.error('Error fetching temperature:', error);
                tempValue.textContent = 'ERR';
                lastUpdate.textContent = 'LAST UPDATE: FAILED';
                updateDeviceStatus(false);
            }
        }
        
        // Event Listeners
        refreshBtn.addEventListener('click', fetchTemperature);
        
        alertBtn.addEventListener('click', () => {
            const threshold = prompt('Set temperature alarm threshold (°C):', '30');
            if(threshold) {
                alarmThreshold = parseFloat(threshold);
                alert(`Alarm set for ${threshold}°C!`);
                
                // Immediately check if we're above threshold
                if (currentTemp !== null && currentTemp > alarmThreshold) {
                    document.body.classList.add('alarm-active');
                    alarmActive = true;
                    alarmIndicator.textContent = `ALARM! TEMP EXCEEDED ${alarmThreshold}°C!`;
                }
            }
        });
        
        // Initialize
        fetchTemperature();
        setInterval(fetchTemperature, 5000); // Refresh every 5 seconds
    </script>
</body>
</html>